import bs4 as BeautifulSoup
import os
from slugify import slugify
import json
from openedxtozim.utils import make_dir, jinja, download

class DragAndDropV2: #IMPROVEMENT We can only see it, not interracting with it
    def __init__(self,json,path,rooturl,id,descendants,mooc):
        self.mooc=mooc
        self.json=json
        self.path=path
        self.rooturl=rooturl
        self.id=id
        self.is_video=True
        self.output_path=self.mooc.output_path
        self.folder_name = slugify(json["display_name"])
        self.output_path = os.path.join(self.mooc.output_path,self.path)
        make_dir(self.output_path)

    def download(self, c):
        print("Offlining drag and drop")
        content=c.get_page(self.json["student_view_url"])
        #print(content)
        soup=BeautifulSoup.BeautifulSoup(content, 'lxml')
        self.content=json.loads(soup.find('script', attrs={"class": "xblock-json-init-args"}).get_text())
        #item
        for item in self.content["items"]:
            name=os.path.basename(item["expandedImageURL"])
            download(item["expandedImageURL"], os.path.join(self.output_path,name),self.mooc.instance_url)
            item["expandedImageURL"]=os.path.join(self.folder_name,name)
        #Grid
        name=os.path.basename(self.content["target_img_expanded_url"])
        download(self.content["target_img_expanded_url"], os.path.join(self.output_path,name),self.mooc.instance_url)
        self.content["target_img_expanded_url"]=os.path.join(self.folder_name,name)
        print(self.content)

    def render(self):
            return jinja(
                None,
                "DragAndDropV2.html",
                False,
                DragDrop=self
            )
"""
Info from html
    {"show_problem_header": false, "url_name": "d6cbf72d947046d9a916dc5349ee38d1", "graded": false, "title": "Question 5", "display_zone_labels": false, "weighted_max_score": 4.0, "max_items_per_zone": 1, "problem_text": "<pRemplissez le tableau en d\u00e9pla\u00e7ant les items au bon endroit.<\/p>\n<ol style=\"list-style-type:upper-alpha; font-weight: bold;  color:#800000;\">\n      <li><span style=\"font-weight: normal; color:black;\">Placez les quatre forces fondamentales de la nature en ordre d\u2019intensit\u00e9 d\u00e9croissante (colonne 1). <\/span><\/li>\n       <li><span style=\"font-weight: normal; color:black;\">Associez une d\u00e9finition et un exemple \u00e0 chacune des forces (colonnes 2 et 3).<\/span><\/li>\n       <li><span style=\"font-weight: normal; color:black;\">Indiquez l\u2019intensit\u00e9 relative des forces, la force la plus forte ayant une valeur de 1 (colonne 4).<\/span><\/li>\n<\/ol>", "zones": [{"uid": "top", "title": "1.1", "align": "center", "height": "100", "width": "235", "y": "70", "x": "0", "description": "colonne 1 case 1"}, {"uid": "zone-1", "title": "1.2", "align": "center", "height": "100", "width": "235", "y": "184", "x": 0, "description": "colonne 1 case 2"}, {"uid": "zone-2", "title": "1.3", "align": "center", "height": "100", "width": "235", "y": "296", "x": 0, "description": "colonne 1 case 3"}, {"uid": "zone-3", "title": "1.4", "align": "center", "height": "100", "width": "235", "y": "410", "x": 0, "description": "colonne 1 case 4"}, {"uid": "zone-4", "title": "2.1", "align": "center", "height": 100, "width": "235", "y": "70", "x": "238", "description": "colonne 2 case 1"}, {"uid": "zone-5", "title": "2.2", "align": "center", "height": 100, "width": "235", "y": "184", "x": "238", "description": "colonne 2 case 2"}, {"uid": "zone-6", "title": "2.3", "align": "center", "height": 100, "width": "235", "y": "296", "x": "238", "description": "colonne 2 case 3"}, {"uid": "zone-7", "title": "2.4", "align": "center", "height": 100, "width": "235", "y": "410", "x": "238", "description": "colonne 2 case 4"}, {"uid": "zone-8", "title": "3.1", "align": "center", "height": 100, "width": "235", "y": "70", "x": "476", "description": "colonne 3 case 1"}, {"uid": "zone-9", "title": "3.2", "align": "center", "height": 100, "width": "235", "y": "184", "x": "476", "description": "colonne 3 case 2"}, {"uid": "zone-10", "title": "3.3", "align": "center", "height": 100, "width": "235", "y": "296", "x": "476", "description": "colonne 3 case 3"}, {"uid": "zone-11", "title": "3.4", "align": "center", "height": 100, "width": "235", "y": "410", "x": "476", "description": "colonne 3 case 4"}, {"uid": "zone-12", "title": "4.1", "align": "center", "height": 100, "width": "235", "y": "70", "x": "714", "description": "colonne 4 case 1"}, {"uid": "zone-13", "title": "4.2", "align": "center", "height": 100, "width": "235", "y": "184", "x": "714", "description": "colonne 4 case 2"}, {"uid": "zone-14", "title": "4.3", "align": "center", "height": 100, "width": "235", "y": "296", "x": "714", "description": "colonne 4 case 3"}, {"uid": "zone-15", "title": "4.4", "align": "center", "height": 100, "width": "235", "y": "410", "x": "714", "description": "colonne 4 case 4"}], "target_img_expanded_url": "\/assets\/courseware\/v1\/0d2ab7d33f89e35d0d8a3925734fd432\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S1_C1.2_Q5.jpg", "mode": "assessment", "show_title": true, "items": [{"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_1.jpg", "imageDescription": "1", "expandedImageURL": "\/assets\/courseware\/v1\/733515e211b8b46d12b4972e4da5ea75\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_1.jpg", "id": 0}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_2.jpg", "imageDescription": "Force reli\u00e9e \u00e0 la d\u00e9sint\u00e9gration \/ s\u00e9paration des particules \u00e9l\u00e9mentaires", "expandedImageURL": "\/assets\/courseware\/v1\/5bf760fd70426eac4521f44f39b26c88\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_2.jpg", "id": 1}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_3.jpg", "imageDescription": "\u00c9lectromagn\u00e9tique", "expandedImageURL": "\/assets\/courseware\/v1\/382e9a5f68755aaa7fda8b9b44fc2224\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_3.jpg", "id": 2}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_4.jpg", "imageDescription": "Forte (nucl\u00e9aire)", "expandedImageURL": "\/assets\/courseware\/v1\/6d311b96e59988526a9ae7beb816c9ef\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_4.jpg", "id": 3}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_5.jpg", "imageDescription": "\u00c9lectricit\u00e9 et magn\u00e9tisme", "expandedImageURL": "\/assets\/courseware\/v1\/0eb5d14dde6b6ea4bb88e2b2c2ffbd05\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_5.jpg", "id": 4}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_6.jpg", "imageDescription": "Syst\u00e8me Terre-Lune", "expandedImageURL": "\/assets\/courseware\/v1\/e414c2e9e0f43b186a50a1d94ff7f2d7\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_6.jpg", "id": 5}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_7.jpg", "imageDescription": "Effets \u00e9lectriques et magn\u00e9tiques reli\u00e9s aux charges \u00e9lectriques", "expandedImageURL": "\/assets\/courseware\/v1\/2892aa55310dfc42708cdfdad99f20ce\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_7.jpg", "id": 6}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_8.jpg", "imageDescription": "Faible (nucl\u00e9aire)", "expandedImageURL": "\/assets\/courseware\/v1\/f16c54483c156fb9a59278c4e6cabc3a\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_8.jpg", "id": 7}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_9.jpg", "imageDescription": "Radioactivit\u00e9", "expandedImageURL": "\/assets\/courseware\/v1\/5a2fa15ff1699e8998cc15f8e06d5f08\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_9.jpg", "id": 8}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_10.jpg", "imageDescription": "Attraction des masses", "expandedImageURL": "\/assets\/courseware\/v1\/3afc3e8cb63b7c60e4d8af2460e6f6b7\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_10.jpg", "id": 9}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_11.jpg", "imageDescription": "10 exposant -5", "expandedImageURL": "\/assets\/courseware\/v1\/edbc27ce2bc49a17b73a238f0e07f146\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_11.jpg", "id": 10}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_12.jpg", "imageDescription": "Bombe atomique ou centrale nucl\u00e9aire", "expandedImageURL": "\/assets\/courseware\/v1\/b40ecba2be658224bac84a890fbfc471\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_12.jpg", "id": 11}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_13.jpg", "imageDescription": "Force qui retient les particules \u00e9l\u00e9mentaires ensemble", "expandedImageURL": "\/assets\/courseware\/v1\/ab4241d3a97cafe881d71f43d594ac93\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_13.jpg", "id": 12}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_14.jpg", "imageDescription": "10 exposant -3", "expandedImageURL": "\/assets\/courseware\/v1\/203baef3c23ba573a17c63d6aeaf96a4\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_14.jpg", "id": 13}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_15.jpg", "imageDescription": "Gravitationnelle", "expandedImageURL": "\/assets\/courseware\/v1\/a86f83b073b3cb8522828a09b8e02198\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_15.jpg", "id": 14}, {"widthPercent": "23.5", "displayName": "", "imageURL": "\/static\/Exercice_S3_test_Q4_16.jpg", "imageDescription": "10 exposant -38", "expandedImageURL": "\/assets\/courseware\/v1\/192bd423912834ba47bac6ec5c79d9ef\/asset-v1:PolyMtl+EMI101.1+P2018+type@asset+block\/Exercice_S3_test_Q4_16.jpg", "id": 15}], "item_background_color": "#800000", "item_text_color": null, "display_zone_borders": false, "target_img_description": "tableau de la question (C1: Forces, C2: D\u00e9finitions, C3: Exemples, C4: Intensit\u00e9)", "max_attempts": 3}




curl 'https://cours.edulib.org/courses/course-v1:PolyMtl+EMI101.1+P2018/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1/handler/publish_event' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Accept-Language: fr,fr-FR;q=0.8,en;q=0.5,en-US;q=0.3' --compressed -H 'Referer: https://cours.edulib.org/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1' -H 'X-CSRFToken: Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'X-Requested-With: XMLHttpRequest' -H 'Cookie: csrftoken=Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG; openedx-language-preference=fr; sessionid="1|d6kp6dzb2rspw8zx6gts1q2bx7h5hlqq|TuB5AdGe6YwN|IjBmMTM3ZjEzZDk2NDJiM2FlZDhhYWNhMzAwOWU3MzlhYmYyNTEyNmRiMjU4Nzk1OWRkMzY4MzlhYmFmMWM5YWEi:1fduBZ:qcHstVWPepGlBl-SZZldL0Cg2uY"; edxloggedin=true; edx-user-info="{\"username\": \"Kiwix\"\054 \"version\": 1\054 \"enrollmentStatusHash\": \"739894a44645af0e9af9bdcf400dcc06\"\054 \"header_urls\": {\"learner_profile\": \"https://cours.edulib.org/u/Kiwix\"\054 \"logout\": \"https://cours.edulib.org/logout\"\054 \"account_settings\": \"https://cours.edulib.org/account/settings\"}}"' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data '{"event_type":"edx.drag_and_drop_v2.item.picked_up","item_id":13}'

curl 'https://cours.edulib.org/courses/course-v1:PolyMtl+EMI101.1+P2018/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1/handler/drop_item' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Accept-Language: fr,fr-FR;q=0.8,en;q=0.5,en-US;q=0.3' --compressed -H 'Referer: https://cours.edulib.org/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1' -H 'X-CSRFToken: Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'X-Requested-With: XMLHttpRequest' -H 'Cookie: csrftoken=Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG; openedx-language-preference=fr; sessionid="1|d6kp6dzb2rspw8zx6gts1q2bx7h5hlqq|1XbjqwJ0jUny|IjBmMTM3ZjEzZDk2NDJiM2FlZDhhYWNhMzAwOWU3MzlhYmYyNTEyNmRiMjU4Nzk1OWRkMzY4MzlhYmFmMWM5YWEi:1fduBh:LeGZQIpIx7gs2SyX-nryS6ha2xs"; edxloggedin=true; edx-user-info="{\"username\": \"Kiwix\"\054 \"version\": 1\054 \"enrollmentStatusHash\": \"739894a44645af0e9af9bdcf400dcc06\"\054 \"header_urls\": {\"learner_profile\": \"https://cours.edulib.org/u/Kiwix\"\054 \"logout\": \"https://cours.edulib.org/logout\"\054 \"account_settings\": \"https://cours.edulib.org/account/settings\"}}"' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data '{"val":13,"zone":"top"}'

curl 'https://cours.edulib.org/courses/course-v1:PolyMtl+EMI101.1+P2018/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1/handler/do_attempt' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Accept-Language: fr,fr-FR;q=0.8,en;q=0.5,en-US;q=0.3' --compressed -H 'Referer: https://cours.edulib.org/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1' -H 'X-CSRFToken: Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'X-Requested-With: XMLHttpRequest' -H 'Cookie: csrftoken=Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG; openedx-language-preference=fr; sessionid="1|d6kp6dzb2rspw8zx6gts1q2bx7h5hlqq|3piI4ywnTgao|IjBmMTM3ZjEzZDk2NDJiM2FlZDhhYWNhMzAwOWU3MzlhYmYyNTEyNmRiMjU4Nzk1OWRkMzY4MzlhYmFmMWM5YWEi:1fduBj:lRIjBCkT0zCd4ylwwLGTuwUk91g"; edxloggedin=true; edx-user-info="{\"username\": \"Kiwix\"\054 \"version\": 1\054 \"enrollmentStatusHash\": \"739894a44645af0e9af9bdcf400dcc06\"\054 \"header_urls\": {\"learner_profile\": \"https://cours.edulib.org/u/Kiwix\"\054 \"logout\": \"https://cours.edulib.org/logout\"\054 \"account_settings\": \"https://cours.edulib.org/account/settings\"}}"' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data '{}'

curl 'https://cours.edulib.org/courses/course-v1:PolyMtl+EMI101.1+P2018/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1/handler/show_answer' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:63.0) Gecko/20100101 Firefox/63.0' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Accept-Language: fr,fr-FR;q=0.8,en;q=0.5,en-US;q=0.3' --compressed -H 'Referer: https://cours.edulib.org/xblock/block-v1:PolyMtl+EMI101.1+P2018+type@drag-and-drop-v2+block@d6cbf72d947046d9a916dc5349ee38d1' -H 'X-CSRFToken: Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG' -H 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8' -H 'X-Requested-With: XMLHttpRequest' -H 'Cookie: csrftoken=Ee6wpBaZ0BJzDAKwrs8ROBfKIODA8uWG; openedx-language-preference=fr; sessionid="1|d6kp6dzb2rspw8zx6gts1q2bx7h5hlqq|FNndzR0rJWYb|IjBmMTM3ZjEzZDk2NDJiM2FlZDhhYWNhMzAwOWU3MzlhYmYyNTEyNmRiMjU4Nzk1OWRkMzY4MzlhYmFmMWM5YWEi:1fduBs:sDRV_HgAL1s7kxMjpt4Z8CgXfk4"; edxloggedin=true; edx-user-info="{\"username\": \"Kiwix\"\054 \"version\": 1\054 \"enrollmentStatusHash\": \"739894a44645af0e9af9bdcf400dcc06\"\054 \"header_urls\": {\"learner_profile\": \"https://cours.edulib.org/u/Kiwix\"\054 \"logout\": \"https://cours.edulib.org/logout\"\054 \"account_settings\": \"https://cours.edulib.org/account/settings\"}}"' -H 'Connection: keep-alive' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data '{}'
=>
{"items": {"11": {"correct": true, "zone": "zone-8"}, "10": {"correct": true, "zone": "zone-14"}, "13": {"correct": true, "zone": "zone-13"}, "12": {"correct": true, "zone": "zone-4"}, "15": {"correct": true, "zone": "zone-15"}, "14": {"correct": true, "zone": "zone-3"}, "1": {"correct": true, "zone": "zone-6"}, "0": {"correct": true, "zone": "zone-12"}, "3": {"correct": true, "zone": "top"}, "2": {"correct": true, "zone": "zone-1"}, "5": {"correct": true, "zone": "zone-11"}, "4": {"correct": true, "zone": "zone-9"}, "7": {"correct": true, "zone": "zone-2"}, "6": {"correct": true, "zone": "zone-5"}, "9": {"correct": true, "zone": "zone-7"}, "8": {"correct": true, "zone": "zone-10"}}}













"""
